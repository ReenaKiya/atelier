{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.
  The product object is null or when placeholders are rendered.

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
  @param {number} [product_card_gap] - The gap between the product card children (overrides block settings)
{%- enddoc -%}

{% style %}
  {% if request.visual_preview_mode %}
    product-card-link {
      width: 100%;
      min-width: 250px;
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign has_quick_add = false
  if settings.quick_add and product.available
    assign has_quick_add = true
  endif

  assign has_mobile_quick_add = false
  if has_quick_add and settings.mobile_quick_add
    assign has_mobile_quick_add = true
  endif

  assign product_card_id = 'product-card-link-' | append: block.id | append: '-' | append: product.id
  assign product_card_gap_value = product_card_gap | default: block.settings.product_card_gap

  if settings.transition_to_main_product
    assign featured_image = product.selected_or_first_available_variant.featured_image
    if featured_image == blank
      assign featured_image = product.featured_media.preview_image
    endif

    if featured_image != blank
      assign featured_media_url = featured_image | image_url: width: 500
    endif
  endif

  assign onboarding = false
  if product.id == empty
    assign onboarding = true
  endif
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
  >
{%- endif -%}
<product-card
  class="product-card"
  data-product-id="{{ product.id }}"
  data-product-variants-size="{{ product.variants.size }}"
  id="product-card-{{ block.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
  {{ block.shopify_attributes }}
>
  <a
    id="{{ product_card_id | md5 }}"
    {% unless onboarding %}
      href="{{ product.selected_or_first_available_variant.url }}"
      on:click="/navigateToProduct"
    {% endunless %}
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
      {% if block.settings.inherit_color_scheme == false %} color-{{ block.settings.color_scheme }}{% endif %}
    "
    style="
      {% render 'border-override', settings: block.settings %}
      {% render 'layout-panel-style', settings: block.settings %}
      {% render 'spacing-style', settings: block.settings %}
      {% render 'gap-style', value: product_card_gap_value, name: 'product-card-gap' %}
      --quick-add-display: {% if has_quick_add %}flex{% else %}none{% endif %};
      --quick-add-mobile-display: {% if has_mobile_quick_add %}flex{% else %}none{% endif %};
      {% if block.settings.padding-inline-start > 0 %}--zoom-out-padding-inline-start: min(var(--padding-xs), {{ block.settings.padding-inline-start | times: 0.7}}px);{% endif %}
      {% if block.settings.padding-inline-end > 0 %}--zoom-out-padding-inline-end: min(var(--padding-xs), {{ block.settings.padding-inline-end | times: 0.7}}px);{% endif %}
      {% if block.settings.padding-block-start > 0 %}--zoom-out-padding-block-start: min(var(--padding-xs), {{ block.settings.padding-block-start | times: 0.7}}px);{% endif %}
      {% if block.settings.padding-block-end > 0 %}--zoom-out-padding-block-end: min(var(--padding-xs), {{ block.settings.padding-block-end | times: 0.7}}px);{% endif %}
    "
  >
    {{ children }}
    {%- comment -%}
  Show stars, rating number, and review count.
  Requires product.metafields.reviews.rating (decimal) and optionally
  product.metafields.reviews.count (integer).
{%- endcomment -%}

{% if product and product.metafields.reviews and product.metafields.reviews.rating.value != blank %}
  {%- comment -%} Coerce to number {% endcomment -%}
  {% assign rating = product.metafields.reviews.rating.value | times: 1 %} 
  {% assign review_count = product.metafields.reviews.count.value | default: 0 | times: 1 %}

  {%- comment -%} Compute full / half / empty stars robustly {% endcomment -%}
  {% assign full_stars = rating | floor %}
  {% assign decimal = rating | minus: full_stars %}
  {% if decimal >= 0.75 %}
    {% assign full_stars = full_stars | plus: 1 %}
    {% assign half_star = 0 %}
  {% elsif decimal >= 0.25 %}
    {% assign half_star = 1 %}
  {% else %}
    {% assign half_star = 0 %}
  {% endif %}
  {% assign empty_stars = 5 | minus: full_stars | minus: half_star %}

  <div class="product-rating" style="margin-top:6px; display:flex; align-items:center; gap:8px; font-size:14px;">
    <span class="stars" aria-hidden="true" style="display:inline-flex; gap:2px; align-items:center;">
      {%- comment -%} Full star SVG {% endcomment -%}
      {% for i in (1..full_stars) %}
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 .587l3.668 7.431L23.5 9.75l-5.75 5.602L19.334 24 12 19.897 4.666 24l1.584-8.648L.5 9.75l7.832-1.732z" />
        </svg>
      {% endfor %}

      {%- comment -%} Half star SVG {% endcomment -%}
      {% if half_star == 1 %}
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="half-grad-{{ block.id }}-{{ product.id }}" x1="0" x2="1">
              <stop offset="50%" stop-color="currentColor" />
              <stop offset="50%" stop-color="transparent" />
            </linearGradient>
          </defs>
          <path d="M12 .587l3.668 7.431L23.5 9.75l-5.75 5.602L19.334 24 12 19.897 4.666 24l1.584-8.648L.5 9.75l7.832-1.732z" fill="url(#half-grad-{{ block.id }}-{{ product.id }})" stroke="currentColor" />
        </svg>
      {% endif %}

      {%- comment -%} Empty star SVG {% endcomment -%}
      {% for i in (1..empty_stars) %}
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 .587l3.668 7.431L23.5 9.75l-5.75 5.602L19.334 24 12 19.897 4.666 24l1.584-8.648L.5 9.75l7.832-1.732z" fill="none" stroke="currentColor" />
        </svg>
      {% endfor %}
    </span>

    <span class="rating-number" aria-label="rating">({{ rating }})</span>

    {% if review_count > 0 %}
      <span class="rating-text"> {{ review_count }} reviews</span>
    {% endif %}
  </div>
{% endif %}

    {% if block.settings.show_product_button %}
    <a
  href="{{ product.url }}"
  class="button button--primary product-card__custom-button"
  style="margin-top: 10px; display: inline-block;"
>
  {{ block.settings.product_button_text }}
</a>
    {% endif %}


    {% if block.settings.show_product_button %}
  <a href="{{ product.url }}" class="product-card__button">
    {{ block.settings.product_button_text }}
  </a>
{% endif %}

  </div>
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}

{% stylesheet %}
  product-card-link {
    width: 100%;
  }

  .product-card__placeholder-image svg {
    height: 100%;
  }

  @media screen and (max-width: 749px) {
    .product-card slideshow-arrows .slideshow-control {
      display: none;
    }
  }

  /* Hide the variant swatches for product cards that show a swatches variant picker */
  :is(.product-card):has(swatches-variant-picker-component) .quick-add .variant-option--swatches {
    display: none;
  }

  /* Hide "Add" button for single option product cards that show a swatches variant picker */
  :is(.product-card):has(.quick-add__product-form-component--single-option):has(swatches-variant-picker-component)
    .quick-add__button--choose {
    display: none;
  }

  /* Hide "add" button for multi-variant product cards that don't show a swatches variant picker */
  :is(.product-card):has(.quick-add__product-form-component--multi-variant):not(:has(swatches-variant-picker-component))
    .quick-add__button--add {
    display: none;
  }

  /* Hover effect for single variant product cards and product blocks */

  /* stylelint-disable selector-max-specificity */
  :is(.product-card):has(.quick-add__product-form-component--single-variant) .card-gallery:hover {
    & .quick-add__button--choose {
      display: none;
    }

    & .quick-add__button--add {
      display: grid;
    }
  }
{% endstylesheet %}
