<section class="offers-timeline">
  <!-- Background Hearts -->
  <div class="offers-timeline__bg-hearts">
    <span class="offers-timeline__bg-heart" style="top:8%;left:3%;font-size:50px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:25%;left:12%;font-size:30px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:5%;right:8%;font-size:60px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:35%;right:3%;font-size:35px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:12%;right:22%;font-size:40px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:65%;left:6%;font-size:25px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:55%;right:12%;font-size:50px;">&#10084;</span>
    <span class="offers-timeline__bg-heart" style="top:70%;left:40%;font-size:20px;">&#10084;</span>
  </div>

  <div class="offers-timeline__container">

    <!-- Video Section -->
    {% if section.settings.video_url != blank %}
      <div class="offers-timeline__video-wrap">
        <video class="offers-timeline__video" autoplay muted loop playsinline>
          <source src="{{ section.settings.video_url }}" type="video/mp4">
        </video>
      </div>
    {% else %}
      <!-- Animated Timeline -->
      <div class="offers-timeline__track" id="offersTrack">

        <!-- Let's Race Start -->
        <div class="offers-timeline__start">
          <span class="offers-timeline__start-text">{{ section.settings.start_text | default: "Let's Race" }}</span>
        </div>

        <!-- Background Line (grey) -->
        <div class="offers-timeline__line-bg"></div>
        <!-- Animated Fill Line -->
        <div class="offers-timeline__line-fill" id="offersLineFill"></div>

        <!-- Milestones -->
        {% for block in section.blocks %}
          <div class="offers-timeline__milestone" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
            <div class="offers-timeline__milestone-top">
              {% if block.settings.icon_type == 'shipping' %}
                <div class="offers-timeline__icon offers-timeline__icon--shipping">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="40" height="40">
                    <rect x="2" y="18" width="36" height="22" rx="2" fill="#8b0000" />
                    <path d="M38 24h10l8 10v6h-18v-16z" fill="#a52a2a" />
                    <circle cx="14" cy="42" r="5" fill="#333" stroke="#666" stroke-width="1.5"/>
                    <circle cx="48" cy="42" r="5" fill="#333" stroke="#666" stroke-width="1.5"/>
                    <rect x="8" y="22" width="8" height="5" rx="1" fill="#fff" opacity="0.3"/>
                    <polygon points="52,28 56,34 48,34" fill="#fff" opacity="0.2"/>
                  </svg>
                </div>
              {% elsif block.settings.icon_type == '10off' %}
                <div class="offers-timeline__icon offers-timeline__icon--discount">
                  <span class="offers-timeline__discount-text">10<sup>%</sup></span>
                  <span class="offers-timeline__discount-sub">OFF</span>
                </div>
              {% elsif block.settings.icon_type == '20off' %}
                <div class="offers-timeline__icon offers-timeline__icon--discount">
                  <span class="offers-timeline__discount-text">20<sup>%</sup></span>
                  <span class="offers-timeline__discount-sub">OFF</span>
                </div>
              {% elsif block.settings.icon_type == '30off' %}
                <div class="offers-timeline__icon offers-timeline__icon--discount">
                  <span class="offers-timeline__discount-text">30<sup>%</sup></span>
                  <span class="offers-timeline__discount-sub">OFF</span>
                </div>
              {% elsif block.settings.icon_type == 'gift' %}
                <div class="offers-timeline__icon offers-timeline__icon--gift">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="40" height="40">
                    <rect x="10" y="28" width="44" height="28" rx="3" fill="#daa520" />
                    <rect x="28" y="28" width="8" height="28" fill="#b8860b" />
                    <rect x="8" y="22" width="48" height="10" rx="3" fill="#ffd700" />
                    <rect x="28" y="22" width="8" height="10" fill="#daa520" />
                    <path d="M32 22c-4-8-14-10-12-4s12 4 12 4z" fill="#8b0000" />
                    <path d="M32 22c4-8 14-10 12-4s-12 4-12 4z" fill="#a52a2a" />
                  </svg>
                </div>
              {% endif %}
              <span class="offers-timeline__label">{{ block.settings.label }}</span>
            </div>
            <div class="offers-timeline__dot"></div>
            <div class="offers-timeline__milestone-bottom">
              <span class="offers-timeline__price">{{ block.settings.price }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Bottom Heading -->
    <h2 class="offers-timeline__heading">{{ section.settings.heading | default: "Valentine's Day Special Offers" }}</h2>
  </div>
</section>

{% schema %}
{
  "name": "Valentine Offers Timeline",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Valentine's Day Special Offers"
    },
    {
      "type": "text",
      "id": "start_text",
      "label": "Start Text",
      "default": "Let's Race"
    },
    {
      "type": "text",
      "id": "video_url",
      "label": "Video URL (MP4)",
      "info": "Paste a video URL to show animated video instead of static timeline. Leave blank for animated timeline.",
      "default": ""
    }
  ],
  "blocks": [
    {
      "type": "milestone",
      "name": "Milestone",
      "settings": [
        {
          "type": "select",
          "id": "icon_type",
          "label": "Icon Type",
          "options": [
            { "value": "shipping", "label": "Free Shipping (Truck)" },
            { "value": "10off", "label": "10% Off" },
            { "value": "20off", "label": "20% Off" },
            { "value": "30off", "label": "30% Off" },
            { "value": "gift", "label": "Free Gift" }
          ],
          "default": "shipping"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Label Text",
          "default": "Free Shipping"
        },
        {
          "type": "text",
          "id": "price",
          "label": "Price",
          "default": "£20"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Valentine Offers Timeline",
      "blocks": [
        { "type": "milestone", "settings": { "icon_type": "shipping", "label": "Free Shipping", "price": "£20" } },
        { "type": "milestone", "settings": { "icon_type": "10off", "label": "10% Discounts", "price": "£25" } },
        { "type": "milestone", "settings": { "icon_type": "20off", "label": "20% Discounts", "price": "£50" } },
        { "type": "milestone", "settings": { "icon_type": "30off", "label": "30% Discounts", "price": "£75" } },
        { "type": "milestone", "settings": { "icon_type": "gift", "label": "Free Gifts", "price": "£100" } }
      ]
    }
  ]
}
{% endschema %}

<style>
.offers-timeline {
  position: relative;
  background: #f9f0f2;
  padding: 50px 20px 40px;
  overflow: hidden;
}

/* Background Hearts */
.offers-timeline__bg-heart {
  position: absolute;
  color: #f5d0d8;
  opacity: 0.35;
  pointer-events: none;
  z-index: 0;
}

.offers-timeline__container {
  position: relative;
  z-index: 1;
  max-width: 1200px;
  margin: 0 auto;
}

/* ===== VIDEO MODE ===== */
.offers-timeline__video-wrap {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  border-radius: 8px;
  overflow: hidden;
}

.offers-timeline__video {
  width: 100%;
  height: auto;
  display: block;
}

/* ===== ANIMATED TIMELINE MODE ===== */
.offers-timeline__track {
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  padding: 70px 0 50px;
}

/* Background Line (grey) */
.offers-timeline__line-bg {
  position: absolute;
  top: 50%;
  left: 80px;
  right: 30px;
  height: 3px;
  background: #ccc;
  transform: translateY(-50%);
  z-index: 0;
}

/* Animated Fill Line (dark) */
.offers-timeline__line-fill {
  position: absolute;
  top: 50%;
  left: 80px;
  width: 0;
  height: 3px;
  background: #333;
  transform: translateY(-50%);
  z-index: 1;
  transition: width 0.3s ease;
}

/* Start Text */
.offers-timeline__start {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 2;
  min-width: 80px;
}

.offers-timeline__start-text {
  font-family: 'Allura', cursive;
  font-size: 28px;
  color: #333;
  white-space: nowrap;
}

/* Milestone */
.offers-timeline__milestone {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 2;
  flex: 1;
  max-width: 160px;
  opacity: 0;
  transform: translateY(15px) scale(0.8);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.offers-timeline__milestone.is-active {
  opacity: 1;
  transform: translateY(0) scale(1);
}

.offers-timeline__milestone-top {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 10px;
}

/* Dot on Line */
.offers-timeline__dot {
  width: 14px;
  height: 14px;
  background: #ccc;
  border-radius: 50%;
  border: 2px solid #ccc;
  position: relative;
  z-index: 3;
  transition: background 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
}

.offers-timeline__milestone.is-active .offers-timeline__dot {
  background: #333;
  border-color: #333;
  transform: scale(1.3);
}

.offers-timeline__milestone-bottom {
  margin-top: 10px;
}

/* Icons */
.offers-timeline__icon {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 5px;
}

.offers-timeline__icon--discount {
  text-align: center;
  line-height: 1;
}

.offers-timeline__discount-text {
  font-size: 32px;
  font-weight: 900;
  color: #8b0000;
  line-height: 1;
  font-family: 'Arial Black', sans-serif;
}

.offers-timeline__discount-text sup {
  font-size: 16px;
  vertical-align: super;
}

.offers-timeline__discount-sub {
  font-size: 16px;
  font-weight: 900;
  color: #8b0000;
  font-family: 'Arial Black', sans-serif;
  letter-spacing: 2px;
}

/* Label */
.offers-timeline__label {
  font-size: 14px;
  color: #333;
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
}

/* Price */
.offers-timeline__price {
  font-size: 22px;
  font-weight: 800;
  color: #333;
}

/* Bottom Heading */
.offers-timeline__heading {
  text-align: center;
  font-family: 'Allura', cursive;
  font-size: 36px;
  color: #333;
  margin-top: 30px;
  font-weight: 400;
}

/* Responsive */
@media screen and (max-width: 768px) {
  .offers-timeline__track {
    padding: 50px 0 30px;
  }

  .offers-timeline__discount-text {
    font-size: 22px;
  }

  .offers-timeline__discount-sub {
    font-size: 12px;
  }

  .offers-timeline__label {
    font-size: 11px;
  }

  .offers-timeline__price {
    font-size: 16px;
  }

  .offers-timeline__start-text {
    font-size: 20px;
  }

  .offers-timeline__icon svg {
    width: 28px;
    height: 28px;
  }

  .offers-timeline__heading {
    font-size: 26px;
  }

  .offers-timeline__line-bg,
  .offers-timeline__line-fill {
    left: 50px;
  }

  .offers-timeline__line-bg {
    right: 15px;
  }
}

@media screen and (max-width: 480px) {
  .offers-timeline {
    padding: 30px 10px 25px;
  }

  .offers-timeline__track {
    padding: 40px 0 20px;
  }

  .offers-timeline__discount-text {
    font-size: 18px;
  }

  .offers-timeline__discount-sub {
    font-size: 10px;
  }

  .offers-timeline__label {
    font-size: 9px;
  }

  .offers-timeline__price {
    font-size: 13px;
  }

  .offers-timeline__start-text {
    font-size: 16px;
  }

  .offers-timeline__dot {
    width: 10px;
    height: 10px;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  var track = document.getElementById("offersTrack");
  if (!track) return;

  var lineFill = document.getElementById("offersLineFill");
  var milestones = track.querySelectorAll(".offers-timeline__milestone");
  var totalMilestones = milestones.length;
  if (totalMilestones === 0) return;

  /* Calculate line positions */
  var lineBg = track.querySelector(".offers-timeline__line-bg");
  var lineLeft = lineBg.offsetLeft;
  var lineWidth = lineBg.offsetWidth;

  var currentStep = -1;
  var animating = false;

  /* Get position % for each milestone along the line */
  function getMilestonePositions() {
    var positions = [];
    for (var i = 0; i < milestones.length; i++) {
      var m = milestones[i];
      var mCenter = m.offsetLeft + (m.offsetWidth / 2) - lineLeft;
      var pct = (mCenter / lineWidth) * 100;
      positions.push(Math.min(pct, 100));
    }
    return positions;
  }

  function runAnimation() {
    if (animating) return;
    animating = true;
    currentStep = -1;

    /* Reset all */
    lineFill.style.transition = "none";
    lineFill.style.width = "0";
    for (var i = 0; i < milestones.length; i++) {
      milestones[i].classList.remove("is-active");
    }

    var positions = getMilestonePositions();
    var stepDelay = 800;

    function nextStep() {
      currentStep++;
      if (currentStep >= totalMilestones) {
        /* All milestones shown — pause then reset and replay */
        setTimeout(function () {
          /* Reverse: remove milestones one by one */
          reverseStep(totalMilestones - 1);
        }, 2000);
        return;
      }

      var targetWidth = (positions[currentStep] / 100) * lineWidth;
      lineFill.style.transition = "width 0.6s ease";
      lineFill.style.width = targetWidth + "px";

      setTimeout(function () {
        milestones[currentStep].classList.add("is-active");
        setTimeout(nextStep, stepDelay);
      }, 600);
    }

    function reverseStep(idx) {
      if (idx < 0) {
        /* Shrink line to 0 */
        lineFill.style.transition = "width 0.6s ease";
        lineFill.style.width = "0";
        setTimeout(function () {
          animating = false;
          /* Restart the animation loop */
          setTimeout(runAnimation, 500);
        }, 700);
        return;
      }

      milestones[idx].classList.remove("is-active");
      var prevWidth = idx > 0 ? (positions[idx - 1] / 100) * lineWidth : 0;
      lineFill.style.transition = "width 0.4s ease";
      lineFill.style.width = prevWidth + "px";

      var positions = getMilestonePositions();
      setTimeout(function () {
        reverseStep(idx - 1);
      }, 500);
    }

    var positions = getMilestonePositions();
    setTimeout(nextStep, 300);
  }

  /* Start animation when section is visible */
  var observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        runAnimation();
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.3 });

  observer.observe(track);
});
</script>
