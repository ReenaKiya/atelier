
<div class="customer-reviews-section page-width">
  {% if section.settings.heading != blank %}
    <h2 class="customer-reviews-heading">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="customer-reviews-overall">
    <div class="overall-rating">
      <div class="overall-stars">
        {% for i in (1..5) %}
          <svg class="star-icon filled" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <path d="M31.547 12a.848.848 0 00-.677-.577l-9.427-1.376-4.224-8.532a.847.847 0 00-1.516 0l-4.218 8.534-9.427 1.355a.847.847 0 00-.467 1.467l6.823 6.664-1.612 9.375a.847.847 0 001.23.893l8.428-4.434 8.432 4.432a.847.847 0 001.229-.894l-1.615-9.373 6.822-6.665a.845.845 0 00.214-.869z" />
          </svg>
        {% endfor %}
      </div>
      <div class="overall-rating-text">
        <span class="review-count">from {{ section.settings.total_reviews | default: 1405 }} reviews</span>
        <svg class="checkmark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="customer-reviews-carousel-wrapper"
       data-autoplay="{{ section.settings.autoplay }}"
       data-autoplay-speed="{{ section.settings.autoplay_speed }}">
    <div class="customer-reviews-carousel" id="reviews-carousel-{{ section.id }}">
      {% for block in section.blocks %}
        <div class="review-card">
          <div class="review-stars">
            {% for i in (1..5) %}
              <svg class="star-icon filled" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <path d="M31.547 12a.848.848 0 00-.677-.577l-9.427-1.376-4.224-8.532a.847.847 0 00-1.516 0l-4.218 8.534-9.427 1.355a.847.847 0 00-.467 1.467l6.823 6.664-1.612 9.375a.847.847 0 001.23.893l8.428-4.434 8.432 4.432a.847.847 0 001.229-.894l-1.615-9.373 6.822-6.665a.845.845 0 00.214-.869z" />
              </svg>
            {% endfor %}
          </div>
          {% if block.settings.headline != blank %}
            <h3 class="review-headline">{{ block.settings.headline }}</h3>
          {% endif %}
          {% if block.settings.body_text != blank %}
            <p class="review-body">{{ block.settings.body_text }}</p>
          {% endif %}
          <div class="review-author">
            {% if block.settings.author_image != blank %}
              <img src="{{ block.settings.author_image | image_url: width: 60 }}" alt="{{ block.settings.author_name }}" class="review-author-image" />
            {% endif %}
            <span class="review-author-name">{{ block.settings.author_name }}</span>
          </div>
        </div>
      {% endfor %}
    </div>

    <button class="carousel-nav-btn prev" aria-label="Previous reviews" onclick="moveCarousel('{{ section.id }}', -1)">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button class="carousel-nav-btn next" aria-label="Next reviews" onclick="moveCarousel('{{ section.id }}', 1)">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</div>

<style>
.customer-reviews-section {
  padding: 60px 20px;
  text-align: center;
  background: white;
}

.customer-reviews-heading {
  color: #ff69b4;
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 30px;
}

.customer-reviews-overall {
  margin-bottom: 40px;
}

.overall-rating {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

.overall-stars {
  display: flex;
  gap: 4px;
}

.overall-stars .star-icon {
  width: 20px;
  height: 20px;
  fill: #bb1e6d;
}

.overall-rating-text {
  display: flex;
  align-items: center;
  gap: 8px;
}

.review-count {
  color: #000;
  font-size: 0.95rem;
}

.checkmark-icon {
  width: 18px;
  height: 18px;
  color: #22c55e;
  flex-shrink: 0;
}

.customer-reviews-carousel-wrapper {
  position: relative;
  max-width: 1200px;
  margin: 0 auto;
}

.customer-reviews-carousel {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  scroll-behavior: smooth;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 10px 0;
}

.customer-reviews-carousel::-webkit-scrollbar {
  display: none;
}

.review-card {
  flex: 0 0 calc(33.333% - 14px);
  min-width: 300px;
  padding: 20px;
  text-align: left;
  scroll-snap-align: start;
}

.review-stars {
  display: flex;
  gap: 4px;
  margin-bottom: 12px;
}

.review-stars .star-icon {
  width: 18px;
  height: 18px;
  fill: #bb1e6d;
}

.review-headline {
  font-size: 1.1rem;
  font-weight: 700;
  color: #000;
  margin-bottom: 10px;
  line-height: 1.4;
}

.review-body {
  font-size: 0.95rem;
  color: #000;
  line-height: 1.6;
  margin-bottom: 15px;
}

.review-author {
  display: flex;
  align-items: center;
  gap: 12px;
}

.review-author-image {
  width: 50px;
  height: 50px;
  border-radius: 4px;
  object-fit: cover;
  flex-shrink: 0;
}

.review-author-name {
  font-size: 0.9rem;
  color: #000;
}

.carousel-nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #e5e5e5;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s ease;
  color: #666;
}

.carousel-nav-btn:hover {
  background: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  color: #000;
}

.carousel-nav-btn.prev {
  left: -20px;
}

.carousel-nav-btn.next {
  right: -20px;
}

.carousel-nav-btn svg {
  width: 20px;
  height: 20px;
}

.carousel-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

@media screen and (max-width: 990px) {
  .review-card {
    flex: 0 0 calc(50% - 10px);
  }

  .carousel-nav-btn.prev {
    left: 10px;
  }

  .carousel-nav-btn.next {
    right: 10px;
  }
}

@media screen and (max-width: 749px) {
  .customer-reviews-section {
    padding: 40px 15px;
  }

  .customer-reviews-heading {
    font-size: 1.5rem;
    margin-bottom: 20px;
  }

  .review-card {
    flex: 0 0 100%;
    min-width: 280px;
  }

  .overall-rating {
    flex-direction: column;
    gap: 10px;
  }

  .carousel-nav-btn {
    width: 35px;
    height: 35px;
  }

  .carousel-nav-btn.prev {
    left: 5px;
  }

  .carousel-nav-btn.next {
    right: 5px;
  }
}
</style>

<script>
let carouselPositions = {};
let autoplayIntervals = {};

function moveCarousel(sectionId, direction) {
  const carousel = document.getElementById('reviews-carousel-' + sectionId);
  if (!carousel) return;

  const cards = carousel.querySelectorAll('.review-card');
  const cardWidth = cards[0]?.offsetWidth || 0;
  const gap = 20;
  const scrollAmount = (cardWidth + gap) * direction;

  carousel.scrollBy({
    left: scrollAmount,
    behavior: 'smooth'
  });

  // Update button states
  updateCarouselButtons(sectionId);
}

function updateCarouselButtons(sectionId) {
  const carousel = document.getElementById('reviews-carousel-' + sectionId);
  if (!carousel) return;

  const prevBtn = carousel.closest('.customer-reviews-carousel-wrapper').querySelector('.prev');
  const nextBtn = carousel.closest('.customer-reviews-carousel-wrapper').querySelector('.next');

  if (prevBtn && nextBtn) {
    const isAtStart = carousel.scrollLeft <= 0;
    const isAtEnd = carousel.scrollLeft >= carousel.scrollWidth - carousel.clientWidth - 10;

    prevBtn.disabled = isAtStart;
    nextBtn.disabled = isAtEnd;
  }
}

function startAutoplay(sectionId, speed) {
  const carousel = document.getElementById('reviews-carousel-' + sectionId);
  if (!carousel) return;

  // Clear existing interval if any
  if (autoplayIntervals[sectionId]) {
    clearInterval(autoplayIntervals[sectionId]);
  }

  autoplayIntervals[sectionId] = setInterval(() => {
    const cards = carousel.querySelectorAll('.review-card');
    if (cards.length === 0) return;

    const cardWidth = cards[0].offsetWidth;
    const gap = 20;
    const scrollAmount = cardWidth + gap;
    const maxScroll = carousel.scrollWidth - carousel.clientWidth;

    // Check if we've reached the end
    if (carousel.scrollLeft >= maxScroll - 10) {
      // Reset to start for infinite loop
      carousel.scrollTo({
        left: 0,
        behavior: 'smooth'
      });
    } else {
      // Move to next card
      carousel.scrollBy({
        left: scrollAmount,
        behavior: 'smooth'
      });
    }

    updateCarouselButtons(sectionId);
  }, speed);
}

function stopAutoplay(sectionId) {
  if (autoplayIntervals[sectionId]) {
    clearInterval(autoplayIntervals[sectionId]);
    autoplayIntervals[sectionId] = null;
  }
}

// Initialize button states and autoplay on load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.customer-reviews-carousel').forEach(carousel => {
    const sectionId = carousel.id.replace('reviews-carousel-', '');
    const wrapper = carousel.closest('.customer-reviews-carousel-wrapper');
    const autoplayEnabled = wrapper.dataset.autoplay === 'true';
    const autoplaySpeed = parseInt(wrapper.dataset.autoplaySpeed) || 3000;

    updateCarouselButtons(sectionId);

    // Update on scroll
    carousel.addEventListener('scroll', () => updateCarouselButtons(sectionId));

    // Start autoplay if enabled
    if (autoplayEnabled) {
      startAutoplay(sectionId, autoplaySpeed);

      // Pause on hover
      wrapper.addEventListener('mouseenter', () => stopAutoplay(sectionId));
      wrapper.addEventListener('mouseleave', () => startAutoplay(sectionId, autoplaySpeed));

      // Pause on touch/interaction
      let userInteracting = false;
      wrapper.addEventListener('touchstart', () => {
        userInteracting = true;
        stopAutoplay(sectionId);
      });
      wrapper.addEventListener('touchend', () => {
        setTimeout(() => {
          userInteracting = false;
          if (autoplayEnabled) startAutoplay(sectionId, autoplaySpeed);
        }, 1000);
      });
    }
  });
});
</script>

{% schema %}
{
  "name": "Customer Reviews",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Let customers speak for us"
    },
    {
      "type": "number",
      "id": "total_reviews",
      "label": "Total Reviews Count",
      "default": 1405
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Auto Slide",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Auto Slide Speed (milliseconds)",
      "min": 2000,
      "max": 8000,
      "step": 500,
      "default": 3000,
      "unit": "ms"
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        {
          "type": "text",
          "id": "headline",
          "label": "Review Headline",
          "default": "Perfect for walking / feeding on the go"
        },
        {
          "type": "textarea",
          "id": "body_text",
          "label": "Review Text",
          "default": "Perfect for walking / feeding on the go. I wear with a sling..."
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Author Name",
          "default": "Kay"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Customer Reviews",
      "blocks": [
        {
          "type": "review",
          "settings": {
            "headline": "Perfect for walking / feeding on the go",
            "body_text": "Perfect for walking / feeding on the go. I wear with a sling...",
            "author_name": "Kay"
          }
        },
        {
          "type": "review",
          "settings": {
            "headline": "So cute - love the colour and flattering too",
            "body_text": "I wanted something for the gym that was 'fit pregnancy'...",
            "author_name": "K."
          }
        },
        {
          "type": "review",
          "settings": {
            "headline": "Beyond supportive",
            "body_text": "This is my second pregnancy and the weight of the baby was so much heavier this tim...",
            "author_name": "Kay"
          }
        }
      ]
    }
  ]
}
{% endschema %}
